<html>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ecos del Alma — Test corregido</title>
<style>
:root{
  --bg:#0b0b0f; --card:#0f1724; --accent:#ffd27f; --text:#e0e6ed; --muted:#93a0b0; --glass:rgba(255,255,255,0.03);
  --border-light: rgba(255,210,127,0.15);
  --font-main: 'Georgia', serif;
  --font-ui: 'Segoe UI', system-ui, sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--font-ui);line-height:1.6;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px;background-image:
  radial-gradient(circle at 20% 20%, rgba(15,23,36,0.8) 0%, transparent 50%),
  radial-gradient(circle at 80% 80%, rgba(255,210,127,0.03) 0%, transparent 30%);}
h1,h2,h3{font-family:var(--font-main);color:var(--accent);font-weight:400;letter-spacing:1px}
header{text-align:center;margin-bottom:28px;margin-top:12px;animation:fadeIn 1s ease-out}
header h1{font-size:2rem;margin-bottom:8px;text-transform:uppercase;text-shadow:0 0 15px rgba(255,210,127,0.2)}
header p{color:var(--muted);font-size:0.95rem;font-style:italic}

/* progress */
.progress-container{width:100%;max-width:680px;margin-bottom:18px;text-align:center;position:sticky;top:8px;z-index:100;background:rgba(11,11,15,0.9);backdrop-filter:blur(5px);padding:10px;border-radius:20px;border:1px solid var(--glass)}
.progress-text{font-size:0.85rem;color:var(--muted);display:block;margin-bottom:6px}
.progress-bar{height:6px;background:var(--glass);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);width:0%;transition:width .45s ease;box-shadow:0 0 10px var(--accent)}

/* quiz */
#quiz-container{width:100%;max-width:680px;padding-bottom:120px}
.card{background:var(--card);border:1px solid var(--border-light);border-radius:14px;padding:26px;margin-bottom:18px;transition:all .45s cubic-bezier(.2,.9,.25,1);position:relative;overflow:hidden;box-shadow:0 6px 30px rgba(0,0,0,.35)}
.card h3{margin-bottom:18px;font-size:1.1rem}
.options-grid{display:flex;flex-direction:column;gap:10px;transition:opacity .35s ease}
.choice-btn{background:var(--glass);border:1px solid rgba(255,255,255,.06);color:var(--muted);padding:12px 14px;border-radius:10px;cursor:pointer;text-align:left;font-size:0.98rem;transition:all .22s ease;position:relative}
.choice-btn:hover{background:rgba(255,210,127,0.04);color:var(--accent);transform:translateY(-2px)}
.card.collapsed{padding:12px 26px;background:rgba(15,23,36,0.6);border-color:transparent;opacity:0.7;transform:scale(.993)}
.card.collapsed h3{font-size:1rem;color:var(--muted);margin-bottom:0}
.card.collapsed .options-grid{display:none}
.card.collapsed::after{content:'✔';position:absolute;right:18px;top:50%;transform:translateY(-50%);color:var(--accent)}

/* result */
#result-container{display:none;width:100%;max-width:760px;text-align:center;animation:fadeIn 1s ease;padding:18px}
.result-card{background:linear-gradient(145deg,#0f1724 0%, #0b0b0f 100%);border:1px solid var(--accent);padding:34px;border-radius:18px;box-shadow:0 0 40px rgba(255,210,127,0.05);position:relative}
.faction-title{font-size:2.2rem;margin-bottom:6px;color:var(--accent);text-transform:uppercase;letter-spacing:2px}
.rank-title{font-size:1.05rem;color:#fff;margin-bottom:18px;font-weight:300;letter-spacing:1px}
.meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:18px;margin-bottom:26px;text-align:center}
.meta-item{background:var(--glass);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.05)}
.meta-label{display:block;font-size:0.75rem;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
.meta-value{font-size:1.05rem;color:#fff;font-family:var(--font-main)}
.tarot-section{margin:28px 0;padding:18px;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)}
.tarot-card-name{font-size:1.4rem;color:var(--accent);margin-bottom:8px;font-family:var(--font-main)}
.tarot-meaning{font-style:italic;color:var(--muted);font-size:0.95rem}
.poetic-desc{font-size:1.02rem;line-height:1.7;color:#d1d5db;margin-top:18px}
.restart-btn{margin-top:28px;background:transparent;border:1px solid var(--accent);color:var(--accent);display:inline-block;padding:10px 28px;border-radius:10px}
.restart-btn:hover{background:var(--accent);color:#000}

/* responsive */
@media(max-width:600px){.faction-title{font-size:1.6rem}.card{padding:18px}}
@keyframes fadeIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<header>
  <h1>Ecos del Alma</h1>
  <p>Descubre la naturaleza oculta de tu alma — ahora con matices internos para ángeles y caídos.</p>
</header>

<div class="progress-container" id="progress-ui">
  <span class="progress-text" id="progress-text">0 / 12 Respondidas</span>
  <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
</div>

<div id="quiz-container"></div>

<div id="result-container">
  <div class="result-card">
    <h2 class="faction-title" id="res-faction">Facción</h2>
    <h3 class="rank-title" id="res-rank">Rango</h3>

    <div class="meta-grid">
      <div class="meta-item">
        <span class="meta-label">Rol Espiritual</span>
        <span class="meta-value" id="res-role">--</span>
      </div>
      <div class="meta-item" id="office-container" style="display:none">
        <span class="meta-label" id="office-label">Oficio</span>
        <span class="meta-value" id="res-office">--</span>
      </div>
    </div>

    <div class="tarot-section">
      <div class="meta-label">Arcano Asignado</div>
      <div class="tarot-card-name" id="res-tarot-card">La Carta</div>
      <div class="tarot-meaning" id="res-tarot-meaning">"Significado..."</div>
    </div>

    <p class="poetic-desc" id="res-desc">Descripción poética...</p>

    <button class="restart-btn" onclick="location.reload()">Reiniciar el Ciclo</button>
  </div>
</div>

<script>
/*
  Versión corregida e integrada:
  - Añade metavalores por respuesta (order, rebel, light, dark, memory, balance)
  - Decide subtipos para Ángeles (Devoto / Juzgador) y Caídos (Redención-Cielo / Redención-Tierra / Irredento)
  - No incluye Basar-Asurim como facción separada
*/

// Preguntas con metadatos añadidos
const questions = [
{ text:"1) Cuando enfrentas una decisión moral, tú:", options:[
  { label:"Sigues el deber y el orden", scores:{angel:3}, meta:{order:2, light:2} },
  { label:"Sigues el corazón y la empatía", scores:{human:3}, meta:{light:2} },
  { label:"Rompes la norma si sirve a tu propósito", scores:{fallen:3}, meta:{rebel:3, dark:2} },
  { label:"Buscas proteger a los tuyos", scores:{nefilim:3}, meta:{balance:1} },
  { label:"Evalúas ventaja y supervivencia", scores:{cambion:3}, meta:{dark:2,rebel:1} },
  { label:"Pienso en lo que mis experiencias pasadas indican", scores:{reinc:3}, meta:{memory:3} }
]},
{ text:"2) Relación con la autoridad:", options:[
  { label:"Orden (obedecer/organizar)", scores:{angel:2}, meta:{order:3} },
  { label:"Cuestionar y reformar", scores:{reinc:2, human:1}, meta:{rebel:2, memory:1} },
  { label:"Liderar con responsabilidad", scores:{angel:1,cambion:2}, meta:{order:1} },
  { label:"Rebelarse por libertad", scores:{fallen:3}, meta:{rebel:3} },
  { label:"Neutral / pragmático", scores:{nefilim:2,human:1}, meta:{balance:2} }
]},
{ text:"3) Tu fuerza principal:", options:[
  { label:"Compasión y guía", scores:{angel:2,human:1}, meta:{light:2} },
  { label:"Memoria y sabiduría", scores:{reinc:3}, meta:{memory:3} },
  { label:"Claridad y juicio", scores:{angel:1,nefilim:1}, meta:{order:2} },
  { label:"Astucia y estrategia", scores:{fallen:1,cambion:2}, meta:{rebel:2} },
  { label:"Poder y presencia", scores:{cambion:2,fallen:1}, meta:{dark:2} }
]},
{ text:"4) Luz o sombra:", options:[
  { label:"Luz (claridad, orden)", scores:{angel:3}, meta:{light:3,order:1} },
  { label:"Sombra (oculto, transformación)", scores:{fallen:2,cambion:2}, meta:{dark:3,rebel:1} },
  { label:"Ambos según necesidad", scores:{nefilim:3,reinc:1}, meta:{balance:2} },
  { label:"Flux — cambio", scores:{human:2,reinc:2}, meta:{memory:2} }
]},
{ text:"5) ¿Has vivido antes?", options:[
  { label:"Sí, muchas veces", scores:{reinc:4}, meta:{memory:4} },
  { label:"No — primera vida", scores:{human:2,angel:1}, meta:{} },
  { label:"Vagos recuerdos", scores:{nefilim:2,fallen:1}, meta:{memory:1} }
]},
{ text:"6) Prefieres:", options:[
  { label:"Enseñar y guiar (maestro)", scores:{angel:1,reinc:1}, meta:{order:1}, role:'teach' },
  { label:"Aprender (discípulo)", scores:{reinc:2,human:1}, meta:{memory:1}, role:'learn' },
  { label:"Actuar solo / independiente", scores:{fallen:1,cambion:1,nefilim:1}, meta:{rebel:1}, role:'solo' }
]},
{ text:"7) Elemento con el que más te identificas:", options:[
  { label:"Aire (mente, mensajería)", scores:{angel:2}, meta:{light:1} },
  { label:"Agua (memoria, emoción)", scores:{reinc:2,human:1}, meta:{memory:2} },
  { label:"Fuego (pasión, transformación)", scores:{fallen:2,cambion:2}, meta:{dark:2,rebel:1} },
  { label:"Tierra (raíces, defensa)", scores:{human:2,nefilim:1}, meta:{balance:1} },
  { label:"Espíritu (más allá)", scores:{nefilim:3,angel:1}, meta:{balance:1,light:1} }
]},
{ text:"8) ¿Cómo resuelves un conflicto?", options:[
  { label:"Negociando y mediando", scores:{human:2,angel:1,nefilim:1}, meta:{order:1} },
  { label:"Por astucia y trampa", scores:{fallen:2,cambion:1}, meta:{rebel:2,dark:1} },
  { label:"Con fuerza abierta", scores:{cambion:3,fallen:1}, meta:{dark:2} },
  { label:"Absorbiendo y transformando", scores:{reinc:2,human:1}, meta:{memory:1,balance:1} },
  { label:"Exiliar / separar", scores:{nefilim:2,fallen:1}, meta:{order:1} }
]},
{ text:"9) Prioridad:", options:[
  { label:"Orden cósmico", scores:{angel:3,fallen:1}, meta:{order:3} },
  { label:"Libertad personal", scores:{human:2,cambion:2}, meta:{rebel:2} },
  { label:"Balance entre mundos", scores:{nefilim:3,reinc:1}, meta:{balance:2} }
]},
{ text:"10) Símbolo:", options:[
  { label:"Pluma (mensajería)", scores:{angel:2,fallen:1}, meta:{light:1} },
  { label:"Cadena (atadura)", scores:{fallen:2,reinc:1}, meta:{dark:2} },
  { label:"Espada (protección)", scores:{cambion:2,angel:1}, meta:{order:1} },
  { label:"Raíces (vínculo)", scores:{human:2,reinc:2}, meta:{memory:2} },
  { label:"Llama (transformación)", scores:{nefilim:2,cambion:1}, meta:{dark:1} }
]},
{ text:"11) Momento del día:", options:[
  { label:"Amanecer", scores:{angel:2,human:1}, meta:{solar:2,light:1} },
  { label:"Mediodía", scores:{human:2,cambion:1}, meta:{solar:1} },
  { label:"Atardecer/ocaso", scores:{nefilim:2,reinc:1}, meta:{lunar:1,balance:1} },
  { label:"Medianoche", scores:{fallen:2,cambion:2}, meta:{dark:2} }
]},
{ text:"12) Misión:", options:[
  { label:"Preservar lo sagrado", scores:{angel:3,human:1}, meta:{order:2,light:2} },
  { label:"Aprender y transmitir saberes", scores:{reinc:3,human:1}, meta:{memory:2} },
  { label:"Rebelarse y romper cadenas", scores:{fallen:3,cambion:1}, meta:{rebel:3,dark:1} },
  { label:"Ser puente entre mundos", scores:{nefilim:3,human:1}, meta:{balance:2} },
  { label:"Catalizar transformación", scores:{cambion:2,fallen:1}, meta:{dark:2} }
]}
];

// Estado
let currentScores = { angel:0, fallen:0, nefilim:0, cambion:0, reinc:0, human:0 };
let metaScores = { order:0, rebel:0, light:0, dark:0, memory:0, balance:0, solar:0, lunar:0 };
let roleScores = { teach:0, learn:0, solo:0 };
let answeredCount = 0;

// Renderizar preguntas
function initQuiz(){
  const container = document.getElementById('quiz-container');
  container.innerHTML = '';
  questions.forEach((q, idx) => {
    const card = document.createElement('div'); card.className='card'; card.id=`q-${idx}`;
    const title = document.createElement('h3'); title.innerText = q.text; card.appendChild(title);
    const opts = document.createElement('div'); opts.className='options-grid';
    q.options.forEach(opt => {
      const btn = document.createElement('button'); btn.className='choice-btn'; btn.innerText = opt.label;
      btn.onclick = ()=> handleAnswer(idx,opt,btn);
      btn.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); btn.click(); } });
      opts.appendChild(btn);
    });
    card.appendChild(opts); container.appendChild(card);
  });
  updateProgress();
}

function handleAnswer(index, option, btn){
  // actualizar scores de facciones
  for(const f in option.scores){
    if(currentScores[f] !== undefined) currentScores[f] += option.scores[f] || 0;
  }
  // actualizar metas
  if(option.meta){
    for(const m in option.meta){
      if(metaScores[m] !== undefined) metaScores[m] += option.meta[m] || 0;
    }
  }
  // role
  if(option.role) roleScores[option.role] = (roleScores[option.role]||0) + 1;

  answeredCount++;
  updateProgress();

  const card = document.getElementById(`q-${index}`);
  card.classList.add('collapsed');

  const next = index + 1;
  if(next < questions.length){
    setTimeout(()=>{ document.getElementById(`q-${next}`).scrollIntoView({behavior:'smooth', block:'center'}); }, 320);
  } else {
    setTimeout(calculateAndShowResults, 640);
  }
}

function updateProgress(){
  const percent = (answeredCount / questions.length) * 100;
  document.getElementById('progress-fill').style.width = `${percent}%`;
  document.getElementById('progress-text').innerText = `${answeredCount} / ${questions.length} Respondidas`;
}

// Lógica de resultados con subtipos
function calculateAndShowResults(){
  // ocultar quiz
  document.getElementById('quiz-container').style.display = 'none';
  document.getElementById('progress-ui').style.display = 'none';

  // escoger facción ganadora
  let winner = 'human'; let maxScore=-1;
  for(const [f,s] of Object.entries(currentScores)){
    if(s > maxScore){ maxScore=s; winner=f; }
  }

  // decidir rol
  let winnerRole='Independiente'; let maxR=-1;
  const roleMap = { teach:'Maestro', learn:'Discípulo', solo:'Independiente' };
  for(const [r,s] of Object.entries(roleScores)){ if(s>maxR){ maxR=s; winnerRole=roleMap[r]; } }

  // calcular subtipo para Ángeles y Caídos usando metaScores
  let subtype = null;
  if(winner === 'angel'){
    // Devoto: order+light >> rebel+dark
    const pro = (metaScores.order||0) + (metaScores.light||0);
    const con = (metaScores.rebel||0) + (metaScores.dark||0);
    if(pro >= con + 3) subtype = 'Devoto';
    else if(metaScores.order >= Math.max(metaScores.rebel, metaScores.dark)) subtype = 'Juzgador';
    else subtype = 'Devoto';
  } else if(winner === 'fallen'){
    const proOrder = metaScores.order || 0;
    const proLight = metaScores.light || 0;
    const proRebel = metaScores.rebel || 0;
    const proDark = metaScores.dark || 0;
    const proBalance = metaScores.balance || 0;
    if(proOrder > proRebel && proLight > proDark) subtype = 'Caído en Búsqueda de Redención (Retorno al Cielo)';
    else if(proLight > proDark && proRebel >= proOrder && proBalance >= 1) subtype = 'Caído Redentor (Permanece en la Tierra)';
    else if(proRebel > proOrder && proDark > proLight) subtype = 'Irredento';
    else subtype = 'Errante';
  }

  // obtener datos de resultado
  const result = getResultData(winner, currentScores[winner], winnerRole, subtype);

  // mostrar
  document.getElementById('res-faction').innerText = result.factionName;
  document.getElementById('res-rank').innerText = result.rank + (subtype ? ` — ${subtype}` : '');
  document.getElementById('res-role').innerText = result.role;
  if(result.office){
    document.getElementById('office-container').style.display = 'block';
    document.getElementById('office-label').innerText = (winner === 'fallen') ? 'Oficio Caído' : 'Oficio Angelical';
    document.getElementById('res-office').innerText = result.office;
  } else {
    document.getElementById('office-container').style.display = 'none';
  }
  document.getElementById('res-tarot-card').innerText = result.tarotCard;
  document.getElementById('res-tarot-meaning').innerText = result.tarotMeaning;
  document.getElementById('res-desc').innerText = result.description;

  document.getElementById('result-container').style.display = 'block';
  document.getElementById('result-container').scrollIntoView({behavior:'smooth', block:'center'});
}

// logística de resultados
function getResultData(faction, score, role, subtype){
  const isHigh = score > 18;
  const isMid = score > 12;
  const data = { factionName:'', rank:'', role:role, office:null, tarotCard:'', tarotMeaning:'', description:'' };

  switch(faction){
    case 'angel':
      data.factionName = 'Ángel';
      data.rank = isHigh ? 'Serafín / Trono' : (isMid ? 'Arcángel' : 'Ángel Mensajero');
      data.office = getAngelicOffice('light');
      const angelTarots = [
        {c:'El Sol', m:'Claridad absoluta, gloria y verdad revelada.'},
        {c:'El Hierofante', m:'Sabiduría tradicional, puente entre lo divino y lo humano.'},
        {c:'El Juicio', m:'Renacimiento, llamada interior y absolución.'}
      ];
      const at = angelTarots[Math.floor(Math.random()*angelTarots.length)];
      data.tarotCard = at.c; data.tarotMeaning = at.m;
      data.description = "Tu esencia vibra con las esferas celestes. Eres leal a tu tarea y buscas preservar lo sagrado. Tiendes a juzgar con severidad solo cuando la verdad lo exige.";
      if(subtype === 'Juzgador') data.description = "Eres un ángel de juicio: firme, justo y a veces severo. Cumples la ley divina con una mirada que no perdona la mentira, pero no has caído.";
      break;

    case 'fallen':
      data.factionName = 'Ángel Caído';
      data.rank = isHigh ? 'Príncipe Caído' : (isMid ? 'Exiliado' : 'Caído Menor');
      data.office = getAngelicOffice('dark');
      const fallenTarots = [
        {c:'La Torre', m:'La destrucción necesaria de estructuras falsas.'},
        {c:'El Colgado', m:'Sacrificio, nueva perspectiva y pausa iluminada.'}
      ];
      const ft = fallenTarots[Math.floor(Math.random()*fallenTarots.length)];
      data.tarotCard = ft.c; data.tarotMeaning = ft.m;
      data.description = "Conoces la luz, pero abrazaste tu propia verdad. Rompiste el pacto, y ahora vives con el peso de esa elección.";
      if(subtype && subtype.includes('Redención')) data.description = "Aún con las sombras en tu alma, buscas reparar y ascender — sea volviendo al cielo o redimiéndote en la tierra con tus propias normas.";
      else if(subtype === 'Irredento') data.description = "Has abrazado la ruptura y tu senda no busca la vuelta. Encuentras libertad en la sombra.";
      break;

    case 'nefilim':
      data.factionName = 'Nefelim';
      data.rank = isHigh ? 'Guardián' : (isMid ? 'Protector' : 'Errante');
      data.tarotCard = 'La Templanza'; data.tarotMeaning = 'Alquimia interior, equilibrio entre mundos opuestos.';
      data.description = "Eres puente entre lo humano y lo divino. Llevas la fuerza y la ternura; tu tarea es equilibrar.";
      break;

    case 'cambion':
      data.factionName = 'Cambión';
      data.rank = isHigh ? 'Señor' : (isMid ? 'Guerrero' : 'Huérfano');
      const cambionTarots = [{c:'El Diablo', m:'Atadura a la materia, pasión cruda y voluntad de poder.'},{c:'La Muerte', m:'Transformación radical.'}];
      const ct = cambionTarots[Math.floor(Math.random()*cambionTarots.length)];
      data.tarotCard = ct.c; data.tarotMeaning = ct.m;
      data.description = "Tu astucia y ferocidad son tu herramienta. No eres maldad pura; eres supervivencia con propósito.";
      break;

    case 'reinc':
      data.factionName = 'Alma Reencarnada';
      data.rank = isHigh ? 'Alma Antigua' : (isMid ? 'Alma con Recuerdos' : 'Reencarnado Joven');
      data.tarotCard = 'La Rueda de la Fortuna'; data.tarotMeaning = 'Ciclos eternos, destino y retorno.';
      data.description = "Llevas memorias de vidas pasadas. Tu intuición proviene de lecciones acumuladas y buscas cerrar ciclos.";
      break;

    case 'human':
    default:
      data.factionName = 'Humano';
      data.rank = isHigh ? 'Humano de Fuerte Voluntad' : 'Humano Común';
      data.tarotCard = 'El Loco'; data.tarotMeaning = 'Comienzo, potencial e incertidumbre fértil.';
      data.description = "Tu libertad es tu don: sin la carga de esquemas celestes, eliges y te forjas.";
      break;
  }

  return data;
}

function getAngelicOffice(type){
  if(type==='light'){
    const o=["Mensajero","Custodio","Portador del Alba","Observador del Tiempo","Guardián del Velo","Guía de Caminantes"];
    return o[Math.floor(Math.random()*o.length)];
  } else {
    const o=["Exiliado del Firmamento","Custodio de Secretos Oscuros","Vigilante Enturbiado","Portador del Crepúsculo","Señor de Rupturas"];
    return o[Math.floor(Math.random()*o.length)];
  }
}

// iniciar
initQuiz();
</script>
</body>
</html>
